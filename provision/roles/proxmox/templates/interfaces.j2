# network interface settings; autogenerated
# Please do NOT modify this file directly, unless you know what
# you're doing.
#
# If you want to manage part of the network configuration manually,
# please utilize the 'source' or 'source-directory' directives to do
# so.
# PVE will preserve these directives, but will NOT its network
# configuration from sourced files, so do not attempt to move any of
# the PVE managed interfaces into external files!

auto lo
iface lo inet loopback

iface eth0 inet manual
        broadcast  176.31.107.255
        network 176.31.107.0

iface eth1 inet manual

auto vmbr0
iface vmbr0 inet static
        address  176.31.107.126
        netmask  255.255.255.0
        gateway  176.31.107.254
        bridge_ports eth0
        bridge_stp off
        bridge_fd 0

iface vmbr0 inet6 static
        address  2001:41d0:0008:1c7e::
        netmask  64

auto vmbr1
iface vmbr1 inet static
        address 192.168.0.254
        netmask 255.255.255.0
        bridge_ports none
        bridge_stp off
        bridge_fd 0
        post-up echo 1 > /proc/sys/net/ipv4/ip_forward
        post-up iptables -t nat -A POSTROUTING -s '192.168.0.0/24' -o vmbr0 -j MASQUERADE
        post-down iptables -t nat -D POSTROUTING -s '192.168.0.0/24' -o vmbr0 -j MASQUERADE

        # ssh nat binding
        {% for vm in container_nodes %}
        post-up iptables -t nat -A PREROUTING -i vmbr0 -p tcp --dport {{ vm.ssh_port }} -j DNAT --to {{ vm.ip }}:22
        post-down iptables -t nat -D PREROUTING -i vmbr0 -p tcp --dport {{ vm.ssh_port }} -j DNAT --to {{ vm.ip }}:22
        {% endfor %}

        {% for vm in kvm_nodes %}
        post-up iptables -t nat -A PREROUTING -i vmbr0 -p tcp --dport {{ vm.ssh_port }} -j DNAT --to {{ vm.ip }}:22
        post-down iptables -t nat -D PREROUTING -i vmbr0 -p tcp --dport {{ vm.ssh_port }} -j DNAT --to {{ vm.ip }}:22
        {% endfor %}
